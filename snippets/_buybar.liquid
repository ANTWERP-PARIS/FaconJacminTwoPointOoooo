<!-- HTML -->
<div id="buybar" class=""> 

  <div class="left between">
    <div class="size"> 
      <div class="guide">Size guide</div>
    </div>
    <div class="price"> 
        <div class="no-js-hidden" id="price-{{ section.id }}">
            {%- render 'price', product: product, use_variant: true, show_badges: true, price_class: 'price--large' -%}
        </div>
        {%- if shop.taxes_included or shop.shipping_policy.body != blank -%}
            <div class="product__tax caption rte">
            {%- if shop.taxes_included -%}
                {{ 'products.product.include_taxes' | t }}
            {%- endif -%}
            {%- if shop.shipping_policy.body != blank -%}
                {{ 'products.product.shipping_policy_html' | t: link: shop.shipping_policy.url }}
            {%- endif -%}
            </div>
        {%- endif -%}
        <div>
            {%- form 'product', product, id: 'product-form-installment', class: 'installment caption-large' -%}
            <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
            {{ form | payment_terms }}
            {%- endform -%}
        </div>
    </div>
  </div>

  <div class="right">     
      <div class="add display">
        <span class="yes">Add to Cart</span>
        <span class="no">Notify Restock</span>
      </div>
      <button class="chat-button help"><span>Help</span><i class="fa-solid fa-comment-question"></i></button>
  </div>
</div>



<!-- CSS -->
{%- style -%}
button.product-form__submit {
    display: none !important;
}

#buybar, #buybar.left, 
#buybar .right, #buybar .right .add {
  height: 79px !important;
}

#buybar {
  @media screen and (max-width: 750px) {
    height: 159px !important;
  }
}

#buybar.passed {
  bottom: -80px;

  @media screen and (max-width: 750px) {
    bottom: -160px;
  }
}

#buybar {
  display: flex;
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;

  z-index: 10;
  background: white;

  transition: bottom .4s;
}

#buybar .left, #buybar .right {
  width: 50%;

  @media screen and (max-width: 750px) {
    width: 100%;
  }
}

#buybar .left {
  padding: 0 32px !important;
  justify-content: space-between;
  align-items: center;
}

#buybar .left {
    box-sizing: border-box;
    display: flex;
    flex-wrap: wrap;
}

#buybar .left .price {
    flex-direction: column;
    align-items: flex-end;
}

#buybar .left .price .price--large {
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: center;
    align-items: center;
}

#buybar .left .price .badge {
    margin-left: 7px;
}

#buybar .left .price .price-item {
    margin-right: 0;
}

#buybar .left .price .product__tax {
    margin-top: -6px;
}

#buybar .left .price .product__tax, #buybar .left .price .product__tax * {
    font-size: 13px !important;
    line-height: 24px;
    letter-spacing: .5px;
}

#buybar .left .price .price-item {
    font-size: 20px;
    line-height: 30px;
    letter-spacing: 0;
    font-weight: bold;
}



#buybar .right .add {
    display: flex;
    align-items: center;
    justify-content: center;
    align-items: center;
    padding: 0 !important;
    cursor: pointer;

    transition: background-color .7s !important;
    transition: color .7s;
    background: var(--color-light);
    color: var(--color-black);
}

#buybar .right .add:hover,
#buybar .right .add.flash {
    background: var(--color-black);
}

#buybar .right .add:hover span,
#buybar .right .add.flash span * {
    color: var(--color-white) !important;
}

#buybar .right .add .no,
#buybar .right .add.disabled .yes {
    display: none;
}

#buybar .right .add.disabled .no {
    display: block;
}

{%- endstyle -%}



<!-- JS -->
<script>
// Element exists
$.fn.alive = function() {
    return this.length>0;
}

// Element is the window
$.fn.isWindow = function() {
    let
        t = Object.prototype.toString.call(this[0]),
        a = ['[object DOMWindow]','[object Window]','[object global]'];

    return _.indexOf(a,t)>-1 ? true : false;
}

// Element is in view
$.fn.inView = function() {
    let
        t = $(this),
        w = $(window),

        elt = t.offset().top,
        elb = elt + t.outerHeight(),
        vpt = w.scrollTop(),
        vpb = vpt + w.height();

    return elb > vpt && elt < vpb;
}



// Scroll logic
let buybar = $('#buybar');
$(window).on('scroll', function(e) {
    let p = $('.product-recommendations');
    
    if(p.alive() && buybar.alive())
        p.inView() ? 
            buybar.addClass('passed') : 
            buybar.removeClass('passed');
});
$(window).trigger('scroll');



// ADD TO CART flash
let 
    addbtn = $('#buybar .right .add'),
    addcart = $('product-form form button.product-form__submit');

/*
let wait = setTimeout(() => {
    addbtn.addClass('flash');

    wait = setTimeout(() => {
        addbtn.removeClass('flash');
    }, 2000);
}, 3000);

addbtn.mouseenter(() => {
    clearTimeout(wait);
});
*/

// ADD TO CART logic
let 
    variant = $('variant-radios input[type=radio]'),
    dis = 'disabled', state = true;

variant.change(() => {
    setTimeout(()=>{
        state = addcart.attr(dis);

        state = state ? true : false;
        state ? 
            addbtn.addClass(dis) : 
            addbtn.removeClass(dis);
    }, 500);
});
variant.trigger('change');

addbtn.click(() => {
    let el = !state ? addcart : $('product-form div button.product-form__submit.omnisend-bis-button');
    if(el.alive()) el.trigger('click');    
});



// Tidio
(function() {
    function onTidioChatApiReady() {
        window.tidioChatApi.hide();
        window.tidioChatApi.on("close", function() {
        window.tidioChatApi.hide();
        });
    }

    if (window.tidioChatApi) {
        window.tidioChatApi.on("ready", onTidioChatApiReady);
    } else {
        document.addEventListener("tidioChat-ready", onTidioChatApiReady);
    }

    document.querySelector(".chat-button").addEventListener("click", function() {
        window.tidioChatApi.show();
        window.tidioChatApi.open();
    });
})();
</script>